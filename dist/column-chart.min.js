/*! column-chart 09-04-2015 */
var ColumnChart=ColumnChart||{};ColumnChart.BarChart={},ColumnChart.StackedBarChart={},DEFAULT_HEIGHT=20,ColumnChart.tooltip=function(a){return"<strong>"+a.title+"</strong><p>"+a.text+"</p>"},ColumnChart.LegendControls=function(){this.dispatch=d3.dispatch("showBar","hideBar","showOnly","resetAll")},ColumnChart.LegendControls.prototype.createLegend=function(a,b,c){var d=$("#"+a),e=d.width(),f=this.addPanel_(d);this.addLegend2Panel_(f,b,c,e),this.addListeners_(f,b,c)},ColumnChart.LegendControls.prototype.addPanel_=function(a){var b=d3.select("body").append("div").attr("class","multi-bar-legend").append("svg"),c=b.append("g").attr("transform","translate(0, 20)");return $(".multi-bar-legend").insertBefore($(a)),{svgContainer:b,gContainer:c}},ColumnChart.LegendControls.prototype.addLegend2Panel_=function(a,b,c,d){var e,f,g,h,i,j=25,k=b.domain(),l=10,m=0;k.forEach(function(a,b){f=getTextWidth(a)+70,console.log("Calcd. width: "+f),m=Math.max(m,f)}),console.log("Maxlength: "+m.toString()),i=0,k.forEach(function(c,f){g?(g=h+m,g+m>d&&(g=10,i+=j)):(g=10,h=10),e=a.gContainer.append("g").attr("class","legend-symbol").attr("toggle","show").attr("xshow","false").attr("transform","translate("+g+","+i+")"),e.append("circle").attr("class","legend-symbol-circle").attr("r",5).style({"stroke-width":"2px",fill:b(c),stroke:b(c)}),e.append("text").attr("class","legend-symbol-text").attr("dy","0.32em").attr("dx",8).text(c),h=g});var n=Math.floor((d-l)/m);a.svgContainer.style("width",n*m+40+"px"),a.svgContainer.style("height",i+40+"px")},ColumnChart.LegendControls.prototype.addListeners_=function(a,b,c){var d=this;a.gContainer.selectAll("g").on("click",function(a){return d.onSingleClick_(d,this,c)}).on("dblclick",function(a){return d.onDoubleClick_(d,this,c)})},ColumnChart.LegendControls.prototype.onSingleClick_=function(a,b,c){var d,e,f,g;d=d3.select(b),f=d.select("text").html(),"true"==d.attr("xshow")?(d.attr("xshow","false"),$(".legend-symbol").each(function(a,b){g=d3.select(b),g.select("text").text()!=f&&g.attr("toggle","show").select("circle").style("fill",g.select("circle").style("stroke"))}),a.dispatch.resetAll(b,getKeyByValue(c,f))):(e="show"==d.attr("toggle"),f=d.select("text").html(),e?(d.select("circle").style("fill","white"),a.dispatch.hideBar(b,getKeyByValue(c,f))):(d.select("circle").style("fill",d.select("circle").style("stroke")),a.dispatch.showBar(b,getKeyByValue(c,f))),d.attr("toggle",e?"hide":"show"))},ColumnChart.LegendControls.prototype.onDoubleClick_=function(a,b,c){var d,e,f,g;d=d3.select(b),g="true"==d.attr("xshow"),e=d.select("text").html(),g||($(".legend-symbol").each(function(a,b){f=d3.select(b),f.select("text").text()!=e?f.attr("toggle","hide").select("circle").style("fill","white"):f.attr("toggle","show").select("circle").style("fill",f.select("circle").style("stroke"))}),a.dispatch.showOnly(b,getKeyByValue(c,e)),d.attr("xshow","true"))},ColumnChart.BarChart=function(a){this.tableID_=a,this.defaultHeight_=DEFAULT_HEIGHT,this.maxVal_={}},ColumnChart.BarChart.prototype.onMouseOver_=function(a,b,c){d3.select($(this)[0]).transition().style("opacity",1),b.transition().style("opacity",.9),b.html(ColumnChart.tooltip({title:c,text:this.innerHTML})).style("left",d3.event.pageX+20+"px").style("top",d3.event.pageY-70+"px")},ColumnChart.BarChart.prototype.onMouseOut_=function(a,b){d3.select($(this)[0]).transition().style("opacity",.8),b.transition().style("opacity",0)},ColumnChart.BarChart.prototype.renderInlineBarcharts=function(){for(var a,b,c,d,e,f=$(".barchart"),g=d3.select("body").append("div").attr("class","tooltip").style("opacity",0),h=0;h<f.length;h++)a=f[h],b=a.dataset.forColumn,b in this.maxVal_||(this.maxVal_[b]=0),this.maxVal_[b]=Math.max(this.maxVal_[b],parseFloat(a.dataset.barValue));for(var i=0;i<f.length;i++)a=f[i],b=a.dataset.forColumn,d=$(a).parent(),e=$(d).width(),c=a.dataset.barValue/this.maxVal_[b]*e,d3.select(d[0]).append("svg").style({width:e,height:(this.defaultHeight_+2).toString()}).append("rect").text(a.dataset.barTooltipText).attr("width",c).attr("height",this.defaultHeight_.toString()).style("fill",a.dataset.barColor).style("opacity",.8).on("mouseover",function(a){this.onMouseOver_(a,g,b)}).on("mouseout",function(a){this.onMouseOut_(a,g)}),$(a).remove()},ColumnChart.StackedBarChart=function(a){this.tableID_=a,this.defaultHeight_=DEFAULT_HEIGHT,this.maxVal_={},this.legendCtrl_=new ColumnChart.LegendControls},ColumnChart.StackedBarChart.prototype.getMax_=function(a){for(var b=0;b<a.length;b++)divElem=a[b],colName=divElem.dataset.forColumn,colName in this.maxVal_||(this.maxVal_[colName]=0),this.maxVal_[colName]=Math.max(this.maxVal_[colName],parseFloat(divElem.dataset.stackedBarCount))},ColumnChart.StackedBarChart.prototype.buildData_=function(a,b,c){var d=0;return a.data.forEach(function(e,f){width=e.count/b*c,e.width=width,d+=width,e.xpos=0===f?0:a.data[f-1].xpos+a.data[f-1].width}),d},ColumnChart.StackedBarChart.prototype.onMouseOver_=function(a,b){d3.select(this).transition().style("opacity",1),b.transition().style("opacity",.9),b.html(ColumnChart.tooltip({title:a.col,text:this.innerHTML})).style("left",d3.event.pageX+"px").style("top",d3.event.pageY-70+"px")},ColumnChart.StackedBarChart.prototype.onMouseOut_=function(a,b){d3.select(this).transition().style("opacity",.8),b.transition().style("opacity",0)},ColumnChart.StackedBarChart.prototype.renderInlineBarcharts=function(){var a,b,c,e,f,g,h,i={},j=$("StackedBarChart"),k=d3.scale.category10(),l=d3.select("body").append("div").attr("class","tooltip").style("opacity",0);this.getMax_(j);for(var m=0;m<j.length;m++)a=j[m],b=a.dataset.forColumn,c=JSON.parse(a.dataset.barValueJson),e=this.maxVal_[b],f=$(a).parent(),g=$(f).width(),h=this.buildData_(c,e,g),0===k.domain().length&&k.domain(c.cols),f.attr("sorttable_customkey",a.dataset.stackedBarCount),d3.select(f[0]).append("svg").style({width:g,height:(this.defaultHeight_+2).toString()}).append("g").attr("class","multibar-container").attr("totalval",a.dataset.stackedBarCount).attr("totalwidth",h).attr("colname",b).selectAll("rect").data(c.data).enter().append("rect").text(function(a){return a.cnt_label}).attr("class",function(a){return a.svg_class_id}).attr("x",function(a){return a.xpos}).attr("width",function(a){return a.width}).attr("height",this.defaultHeight_.toString()).attr("value",function(a){return a.count}).style("fill",function(a){return k(a.col)}).style("opacity",.8).on("mouseover",this.onMouseOver_(d,l)).on("mouseout",this.onMouseOut_(d,l)),$(a).remove(),0===d3.keys(i).length&&c.data.forEach(function(a){i[a.svg_class_id]=a.col});this.registerListeners_(),this.legendCtrl_.createLegend(this.tableID_,k,i)},ColumnChart.StackedBarChart.prototype.getColMax=function(a,b,c){var d,e,f,g={};return $(a).each(function(a,h){d=0,$(h).children("rect").each(function(a,f){e=d3.select(f),c?e.classed(b)&&e.classed("bar-hidden")||(d+=parseFloat(d3.select(f).attr("value"))):(e.classed(b)||!e.classed("bar-hidden"))&&(d+=parseFloat(d3.select(f).attr("value")))}),f=d3.select(h).attr("colname"),f in g||(g[f]=0),g[f]=Math.max(g[f],d)}),g},ColumnChart.StackedBarChart.prototype.registerListeners_=function(){var a,b,c,d,e,f,g=$(".multibar-container"),h=this;this.legendCtrl_.dispatch.on("hideBar",function(i,j){console.log("Hiding bar: "+j),maxColVals=h.getColMax(g,j,!1),g.each(function(g,h){gCont=d3.select(h),b=parseFloat(gCont.attr("totalwidth")),b>0&&(xPos=0,parentElemWidth=$(h).parent().parent().width(),a=parseFloat(gCont.attr("totalval")),f=gCont.attr("colname"),$(h).children("rect").each(function(a,b){c=d3.select(b),c.classed("bar-hidden")||(c.classed(j)?(c.transition().attr("width",0),c.classed("bar-hidden",!0)):(d=parseFloat(c.attr("value")),ratio=d/maxColVals[f],ratio=isNaN(ratio)?0:ratio,e=ratio*parentElemWidth,c.transition().attr("width",e),c.attr("x",xPos),c.classed("bar-hidden",!1),xPos+=e))}))})}),this.legendCtrl_.dispatch.on("showBar",function(i,j){console.log("Showing bar: "+j),maxColVals=h.getColMax(g,j,!1),g.each(function(g,h){gCont=d3.select(h),b=parseFloat(gCont.attr("totalwidth")),b>0&&(xPos=0,parentElemWidth=$(h).parent().parent().width(),a=parseFloat(gCont.attr("totalval")),f=gCont.attr("colname"),$(h).children("rect").each(function(a,b){c=d3.select(b),c.classed(j)&&c.classed("bar-hidden",!1),c.classed("bar-hidden")||(d=parseFloat(c.attr("value")),ratio=d/maxColVals[f],ratio=isNaN(ratio)?0:ratio,e=ratio*parentElemWidth,c.transition().attr("width",e),c.attr("x",xPos),xPos+=e)}))})}),this.legendCtrl_.dispatch.on("showOnly",function(a,b){console.log("Showing only: "+b);var d=0;g.each(function(a,e){$(e).children("rect").each(function(a,e){c=d3.select(e),c.classed(b)&&(d=Math.max(d,parseFloat(c.attr("value"))))})});var f,h;g.each(function(a,g){h=$(g).parent().width(),$(g).children("rect").each(function(a,g){c=d3.select(g),c.classed(b)?(f=c.attr("value"),e=f/d*h,c.attr("x",0).transition().attr("width",e),$(g).closest("td").attr("sorttable_customkey",f),c.classed("bar-hidden",!1)):c.classed("bar-hidden",!0)})})}),this.legendCtrl_.dispatch.on("resetAll",function(a,b){console.log("Resetting all b/c u clicked: "+b);var c,d,e,f,h;g.each(function(a,b){svgWidth=parseFloat(d3.select(b).attr("totalwidth")),c=parseFloat(d3.select(b).attr("totalval")),d=0,$(b).children("rect").each(function(a,b){e=d3.select(b),f=parseFloat(e.attr("value")),ratio=f/c,ratio=isNaN(ratio)?0:ratio,h=ratio*svgWidth,e.transition().attr("width",h),e.attr("x",d),e.classed("bar-hidden",!1),d+=h}),$(b).parent().parent().attr("sorttable_customkey",c)})})};